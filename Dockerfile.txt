# syntax=docker/dockerfile:1.4
FROM python:3.11-slim

# 1) Instaliraj sistemske alate i ffmpeg
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      git \
      ffmpeg \
 && rm -rf /var/lib/apt/lists/*

# 2) Postavi da Python ne buffer-uje izlaz (logovi odmah u logovima Railway)
ENV PYTHONUNBUFFERED=1

# 3) Radni direktorij
WORKDIR /app

# 4) Kloniraj repo i pripremi folder-e
RUN git clone https://github.com/HaxWitcher/plex-yt.git /app/plex-yt
WORKDIR /app/plex-yt

RUN mkdir -p output spotify_output \
 && chmod -R 777 output spotify_output \
 && chmod 777 yt.txt

# 5) Instaliraj Python zavisnosti
#    - requests za Spotify
#    - uvicorn[standard] da uključimo websockets i access-log podršku
#    - fastapi, yt-dlp iz requirements.txt
RUN pip install --no-cache-dir \
      requests \
      "uvicorn[standard]" \
 && pip install --no-cache-dir -r requirements.txt

# 6) Expose port FastAPI
EXPOSE 7860

# 7) CMD s uključenim debug i access-log
CMD ["uvicorn", "main:app", \
     "--host", "0.0.0.0", \
     "--port", "7860", \
     "--log-level", "debug", \
     "--access-log"]
